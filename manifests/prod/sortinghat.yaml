apiVersion: v1
kind: Service
metadata:
  name: sortinghat
  namespace: grimoirelab
  labels:
    app.kubernetes.io/name: grimoirelab
    app.kubernetes.io/component: sortinghat
spec:
  ports:
    - name: http
      port: 9314
      targetPort: 9314
  selector:
    app.kubernetes.io/name: grimoirelab
    app.kubernetes.io/component: sortinghat
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sortinghat
  namespace: grimoirelab
  labels:
    app.kubernetes.io/name: grimoirelab
    app.kubernetes.io/component: sortinghat
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: grimoirelab
      app.kubernetes.io/component: sortinghat
  template:
    metadata:
      labels:
        app.kubernetes.io/name: grimoirelab
        app.kubernetes.io/component: sortinghat
    spec:
      initContainers:
        - name: wait-for-backends
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              set -e
              for host in mariadb:3306 valkey:6379; do
                echo "Waiting for $host..."
                until nc -z ${host%:*} ${host#*:}; do
                  sleep 5
                done
              done
      containers:
        - name: sortinghat
          image: grimoirelab/sortinghat:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 9314
          env:
            - name: SORTINGHAT_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: grimoirelab-secrets
                  key: sortinghat-secret-key
            - name: SORTINGHAT_DB_HOST
              value: mariadb
            - name: SORTINGHAT_DB_PORT
              value: "3306"
            - name: SORTINGHAT_DB_DATABASE
              value: sortinghat_db
            - name: SORTINGHAT_DB_USER
              value: root
            - name: SORTINGHAT_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grimoirelab-secrets
                  key: sortinghat-db-password
            - name: SORTINGHAT_REDIS_HOST
              value: valkey
            - name: SORTINGHAT_REDIS_PASSWORD
              value: ""
            - name: SORTINGHAT_SUPERUSER_USERNAME
              value: admin
            - name: SORTINGHAT_SUPERUSER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grimoirelab-secrets
                  key: sortinghat-superuser-password
            - name: SORTINGHAT_ALLOWED_HOST
              value: sortinghat,grimoirelab-gateway,localhost,127.0.0.1,[::1]
            - name: SORTINGHAT_CORS_ALLOWED_ORIGINS
              value: http://localhost:8000,http://127.0.0.1:8000
          readinessProbe:
            tcpSocket:
              port: 9314
            initialDelaySeconds: 30
            periodSeconds: 10
          volumeMounts:
            - name: sortinghat-static
              mountPath: /opt/venv/lib/python3.12/site-packages/sortinghat/static/
      volumes:
        - name: sortinghat-static
          persistentVolumeClaim:
            claimName: sortinghat-static
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sortinghat-worker
  namespace: grimoirelab
  labels:
    app.kubernetes.io/name: grimoirelab
    app.kubernetes.io/component: sortinghat-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: grimoirelab
      app.kubernetes.io/component: sortinghat-worker
  template:
    metadata:
      labels:
        app.kubernetes.io/name: grimoirelab
        app.kubernetes.io/component: sortinghat-worker
    spec:
      initContainers:
        - name: wait-for-backends
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              set -e
              for host in mariadb:3306 valkey:6379; do
                echo "Waiting for $host..."
                until nc -z ${host%:*} ${host#*:}; do
                  sleep 5
                done
              done
      containers:
        - name: sortinghat-worker
          image: grimoirelab/sortinghat-worker:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: SORTINGHAT_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: grimoirelab-secrets
                  key: sortinghat-secret-key
            - name: SORTINGHAT_DB_HOST
              value: mariadb
            - name: SORTINGHAT_DB_PORT
              value: "3306"
            - name: SORTINGHAT_DB_DATABASE
              value: sortinghat_db
            - name: SORTINGHAT_DB_USER
              value: root
            - name: SORTINGHAT_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grimoirelab-secrets
                  key: sortinghat-db-password
            - name: SORTINGHAT_REDIS_HOST
              value: valkey
            - name: SORTINGHAT_REDIS_PASSWORD
              value: ""

